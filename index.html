import React, { useMemo, useState, useEffect, useRef } from "react";

/**
 * Chaotic Cook‑Off — Episode 3: Between the Bread
 * Public microsite. Judges type their NAME to score.
 * Retro poster styling, mobile‑first, colorful, interactive.
 *
 * Google Sheet backend via Google Apps Script (see snippet at bottom).
 * Sheet: Scores (Timestamp | Judge Name | Scores JSON | Totals JSON | Grand Total)
 */

// ====== CONFIG ======
// Paste your Google Apps Script Web App URL here (same URL for send + leaderboard fetch)
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwWi-NH1p4FrnZv5tjKgh_fClXxZa-R8KfPQ9uCp3WKk1Kgih1DQM4zSq-eI87dTwltHA/exec";
const SEND_SCORES_URL = SCRIPT_URL;
const LEADERBOARD_URL = SCRIPT_URL;

// Host detection: if NOT in ChatGPT preview, auto‑refresh by default
const IS_PREVIEW = typeof window !== 'undefined' && /chatgpt|openai/i.test(window.location.host);
const REFRESH_MS = 4000;

const POSTER_IMAGE = ""; // optional hero image URL

const CONTESTANTS = [
  { key: "Rahul", name: "Rahul", region: "Cuba", bio: "Cuban classics • Veg + Non‑veg", img: "" },
  { key: "Aashna", name: "Aashna", region: "Turkey", bio: "Turkish delights • Veg + Non‑veg", img: "" },
  { key: "Rishabh", name: "Rishabh", region: "Vietnam", bio: "Vietnamese vibes • Veg + Non‑veg", img: "" },
] as const;

const CRITERIA = [
  { id: "tasteVeg", label: "Taste (Veg)" },
  { id: "tasteNonVeg", label: "Taste (Non‑Veg)" },
  { id: "presentation", label: "Presentation" },
  { id: "creativity", label: "Creativity / Authenticity" },
  { id: "overall", label: "Overall Satisfaction" },
] as const;

function clampScore(v: number) { return Math.max(0, Math.min(10, Math.round(v))); }
function totalFor(scoresObj: Record<string, number>) { return Object.values(scoresObj).reduce((a,b)=>a+(Number.isFinite(b)?b:0), 0); }
const blankContestantScores = () => CRITERIA.reduce((acc, c) => { acc[c.id] = 0; return acc; }, {} as Record<string, number>);

// ===== Race Ticker =====
function RaceTicker({ totals }: { totals: Record<string, number> }) {
  const order = ["Rahul","Aashna","Rishabh"];
  const max = Math.max(1, ...order.map(k => Number(totals[k] || 0)));
  return (
    <div className="mt-6 p-4 rounded-2xl border-4 border-black bg-[#F9DA85] text-black">
      <div className="text-sm font-extrabold uppercase mb-2">Live Race</div>
      <div className="space-y-3">
        {order.map(k => {
          const val = Number(totals[k] || 0);
          const pct = Math.max(0, Math.min(100, Math.round((val / max) * 100)));
          return (
            <div key={k} className="w-full">
              <div className="flex justify-between text-xs font-bold"><span>{k}</span><span>{val}</span></div>
              <div className="w-full h-5 bg-[#FCE9AF] border-2 border-black rounded-full overflow-hidden">
                <div className="h-full bg-black text-[#F4C44E] text-right pr-2 font-bold" style={{ width: pct + "%", transition: "width 600ms ease" }}>
                  {/* bar */}
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

function TickerFeed({ feed }: { feed: Array<{ name:string, delta:number, total:number, at:string }>}) {
  if (!feed.length) return null;
  return (
    <div className="mt-3 p-3 rounded-xl border-2 border-dashed border-black bg-[#FCE9AF] text-xs">
      <div className="font-bold uppercase mb-1">Scoring Ticker</div>
      <ul className="list-disc pl-5 space-y-1">
        {feed.map((f, i) => (
          <li key={i}><span className="font-bold">{f.name}</span> +{f.delta} → {f.total} <span className="opacity-60">({f.at})</span></li>
        ))}
      </ul>
    </div>
  );
}

export default function CookOffMicrosite() {
  const [judgeName, setJudgeName] = useState("");
  const [isAuthed, setIsAuthed] = useState(false);
  const [scores, setScores] = useState<Record<string, Record<string, number>>>(() => CONTESTANTS.reduce((acc, c) => { acc[c.key] = blankContestantScores(); return acc; }, {} as Record<string, Record<string, number>>));
  const [submitted, setSubmitted] = useState(false);
  const [submitMsg, setSubmitMsg] = useState("");
  const [reveal, setReveal] = useState(false);
  const [leaderboard, setLeaderboard] = useState<{ totals: Record<string, number>, judgeCount: number }>({ totals: {}, judgeCount: 0 });
  const [live, setLive] = useState(false); // toggle auto‑refresh in preview
  const prevTotalsRef = useRef<Record<string, number>>({ Rahul:0, Aashna:0, Rishabh:0 });
  const [feed, setFeed] = useState<Array<{ name:string, delta:number, total:number, at:string}>>([]);

  const totals = useMemo(() => { const t: Record<string, number> = {}; for (const c of CONTESTANTS) t[c.key] = totalFor(scores[c.key] || {}); return t; }, [scores]);
  const grandTotal = useMemo(() => Object.values(totals).reduce((a,b)=>a+b,0), [totals]);

  const handleAuth = () => { if (!judgeName.trim()) return alert("Type your name."); setIsAuthed(true); };

  async function submitAll() {
    try {
      const payload = { judgeName: judgeName.trim(), scores, totalByContestant: totals, grandTotal, completedAt: new Date().toISOString() };
      await fetch(SEND_SCORES_URL, {
        method: "POST",
        mode: "no-cors", // avoid CORS checks in preview
        headers: { "Content-Type": "text/plain;charset=UTF-8" },
        body: JSON.stringify({ action: "submit", ...payload })
      });
      setSubmitMsg("Scores submitted! Check the Sheet → Scores tab.");
      setSubmitted(true);
    } catch (e:any) { setSubmitMsg(e?.message || "Error submitting."); }
  }

  async function fetchLeaderboard() {
    try {
      const res = await fetch(LEADERBOARD_URL+"?action=leaderboard");
      const data = await res.json();
      if (data?.reveal) setReveal(true);
      if (data?.totals) {
        setLeaderboard({ totals: data.totals, judgeCount: data.judgeCount||0 });
        // compute ticker deltas
        const prev = prevTotalsRef.current || { Rahul:0, Aashna:0, Rishabh:0 };
        ["Rahul","Aashna","Rishabh"].forEach(name => {
          const newV = Number((data.totals && data.totals[name]) || 0);
          const oldV = Number((prev && prev[name]) || 0);
          const delta = newV - oldV;
          if (delta > 0) {
            const at = new Date().toLocaleTimeString();
            setFeed(curr => [{ name, delta, total: newV, at }, ...curr].slice(0, 10));
          }
        });
        prevTotalsRef.current = { ...(data.totals || {}) } as Record<string, number>;
      }
    } catch (e) { console.warn("Leaderboard fetch failed", e); }
  }
  // (Preview-friendly) No auto fetch on load to avoid repeated network prompts in canvas.
// useEffect(() => { fetchLeaderboard(); }, []);
  // Auto‑start live mode when hosted (no preview popups)
useEffect(() => { if (!IS_PREVIEW) { setLive(true); fetchLeaderboard(); } }, []);
useEffect(() => { if (live) { const id = setInterval(fetchLeaderboard, REFRESH_MS); return () => clearInterval(id); } }, [live]);

  const ScoreInput = ({ value, onChange }: { value: number; onChange:(v:number)=>void }) => (
    <div className="flex items-center gap-3 w-full">
      <input type="range" min={0} max={10} value={value} onChange={e=>onChange(clampScore(Number(e.target.value)))} className="w-full" />
      <input type="number" min={0} max={10} value={value} onChange={e=>onChange(clampScore(Number(e.target.value)))} className="w-16 border rounded px-2 py-1 text-center" />
    </div>
  );

  function setScore(contestantKey:string, criterionId:string, v:number) { setScores(prev => ({ ...prev, [contestantKey]: { ...prev[contestantKey], [criterionId]: clampScore(v) } })); }

  const retroBg = "bg-[#F4C44E]", retroInk = "text-black";

  return (
    <div className={`min-h-screen ${retroBg} ${retroInk} font-sans`}>
      <div className="max-w-5xl mx-auto px-4 py-6">
        <h1 className="text-3xl font-extrabold uppercase">Chaotic Cook‑Off</h1>
        <p className="uppercase font-black -mt-1">Between the Bread — Episode 3</p>

        {/* Judge Gate (Name only) */}
        {!isAuthed ? (
          <div className="mt-6 p-4 bg-black/10 rounded-2xl">
            <h2 className="font-extrabold">Judge Check‑In</h2>
            <input placeholder="Your Name" value={judgeName} onChange={e=>setJudgeName(e.target.value)} className="px-3 py-2 rounded bg_white bg-white" />
            <button onClick={handleAuth} className="px-4 py-2 mt-2 rounded bg-black text-[#F4C44E] font-bold">Start Scoring</button>
          </div>
        ) : (
          <div className="mt-6">Logged in as {judgeName}</div>
        )}

        {/* Contestant Cards */}
        <div className="mt-6 grid md:grid-cols-3 gap-5">
          {CONTESTANTS.map(c => (
            <div key={c.key} className="rounded-3xl border-4 border-black bg-[#F9DA85] p-4">
              <h3 className="text-xl font-extrabold uppercase">{c.name}</h3>
              <p className="text-xs">{c.region} • {c.bio}</p>
              <div className="mt-4 space-y-3">
                {CRITERIA.map(cr => (
                  <div key={cr.id}>
                    <div className="text-xs font-black uppercase mb-1">{cr.label}</div>
                    <ScoreInput value={(scores[c.key] && scores[c.key][cr.id] !== undefined) ? scores[c.key][cr.id] : 0} onChange={v=>setScore(c.key, cr.id, v)} />
                  </div>
                ))}
              </div>
              <div className="mt-3 font-extrabold">Total: {totals[c.key]}</div>
            </div>
          ))}
        </div>

        {/* Submit */}
        <div className="mt-6 p-4 border-4 border-black bg-[#FCE9AF]">
          <div>Your Grand Total: {grandTotal}</div>
          <button disabled={!isAuthed||submitted} onClick={submitAll} className="px-5 py-3 mt-2 rounded bg-black text-[#F4C44E] font-bold">{submitted?"Submitted":"Submit Final Scores"}</button>
          {submitMsg && <div className="mt-2 text-sm">{submitMsg}</div>}
        </div>

        {/* Results controls */}
        <div className="mt-4 p-3 bg-black/10 rounded-xl border border-black/20">
          <div className="text-xs mb-2 uppercase font-bold">Results</div>
          <div className="flex gap-2 flex-wrap">
            <button onClick={fetchLeaderboard} className="px-3 py-2 rounded bg-black text-[#F4C44E] font-bold text-xs">Check Leaderboard</button>
            <button onClick={()=>setLive(v=>!v)} className="px-3 py-2 rounded bg-black text-[#F4C44E] font-bold text-xs">{live?"Stop Auto‑Refresh":"Enable Auto‑Refresh"}</button>
          </div>
          <div className="text-xs mt-2 opacity-70">
            Leaderboard is always visible; <span className="font-bold">Winner</span> reveals once all judges finish. {IS_PREVIEW ? "(Auto-refresh is off until you enable it here.)" : "(Auto-refresh is ON by default on hosted site.)"}
          </div>
        </div>

        {/* Live Race + Ticker */}
        <RaceTicker totals={leaderboard.totals && Object.keys(leaderboard.totals).length ? leaderboard.totals : prevTotalsRef.current} />
        <TickerFeed feed={feed} />

        {/* Leaderboard */}
        <div className="mt-6 p-5 bg-black text-[#F4C44E] rounded-3xl border-4 border-black">
          <h2 className="text-2xl font-extrabold uppercase">Leaderboard</h2>
          <p className="text-xs">Judges: {leaderboard.judgeCount} {!reveal && "• in progress"}</p>
          <div className="mt-4 grid sm:grid-cols-3 gap-4">
            {CONTESTANTS.map(c => (
              <div key={c.key} className="rounded-2xl bg-[#F4C44E] text-black p-4 border-4 border-black">
                <div className="font-extrabold uppercase">{c.name}</div>
                <div className="text-3xl font-black mt-1">{(leaderboard.totals && leaderboard.totals[c.key] !== undefined) ? leaderboard.totals[c.key] : 0}</div>
              </div>
            ))}
          </div>
          {reveal ? (
            <WinnerBanner totals={leaderboard.totals} />
          ) : (
            <div className="text-xs mt-2 opacity-80">Winner reveals once all judges finish.</div>
          )}
        </div>

        <div className="py-10 text-center opacity-70 text-xs">© Chaotic Cook‑Off — Episode 3. Score fair, eat more. 0 = nope, 10 = legendary.</div>
      </div>
    </div>
  );
}

function WinnerBanner({ totals }: { totals: Record<string, number> }) {
  const entries = Object.entries(totals || {});
  if (!entries.length) return null;
  const max = entries.reduce((acc, cur)=> cur[1] > acc[1] ? cur : acc, entries[0]);
  const [name, score] = max;
  return <div className="mt-6 p-4 border-4 border-black bg-[#F9DA85] text-black text-center"><div className="text-xl font-extrabold">Winner</div><div className="text-3xl font-black mt-1">✨✨✨ {name} — {score} ✨✨✨</div></div>;
}

/**
 * ====== GOOGLE APPS SCRIPT SNIPPET (NO JUDGE ID) ======
 * // Replace SHEET_ID and EXPECTED with your numbers.
 * const SHEET_ID = 'SHEET_ID';
 * const SCORES_SHEET = 'Scores';
 * const EXPECTED = 20; // number of judges to wait for
 *
 * function doPost(e) {
 *   const ss = SpreadsheetApp.openById(SHEET_ID);
 *   const sheet = ss.getSheetByName(SCORES_SHEET);
 *   const data = JSON.parse(e.postData.contents);
 *   if (data.action === 'submit') {
 *     sheet.appendRow([
 *       new Date(),
 *       data.judgeName,
 *       JSON.stringify(data.scores),
 *       JSON.stringify(data.totalByContestant),
 *       data.grandTotal
 *     ]);
 *     return ContentService
 *       .createTextOutput(JSON.stringify({ status: 'ok' }))
 *       .setMimeType(ContentService.MimeType.JSON);
 *   }
 *   return ContentService
 *     .createTextOutput(JSON.stringify({ status: 'noop' }))
 *     .setMimeType(ContentService.MimeType.JSON);
 * }
 *
 * function doGet(e) {
 *   const ss = SpreadsheetApp.openById(SHEET_ID);
 *   const sheet = ss.getSheetByName(SCORES_SHEET);
 *   const rows = sheet.getDataRange().getValues();
 *   const judgeCount = Math.max(rows.length - 1, 0);
 *   const totals = { Rahul: 0, Aashna: 0, Rishabh: 0 };
 *   for (let i = 1; i < rows.length; i++) {
 *     try {
 *       const rowTotals = JSON.parse(rows[i][3]); // TotalsJSON
 *       Object.keys(totals).forEach(k => totals[k] += Number(rowTotals[k] || 0));
 *     } catch (_) {}
 *   }
 *   const reveal = judgeCount >= EXPECTED;
 *   return ContentService
 *     .createTextOutput(JSON.stringify({ reveal, totals, judgeCount }))
 *     .setMimeType(ContentService.MimeType.JSON);
 * }
 */